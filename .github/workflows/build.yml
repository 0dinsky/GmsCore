name: "Gradle build"
permissions: {}
on:
  - push
  - pull_request
  - workflow_dispatch

jobs:
  build:
    name: "Gradle build ${{ matrix.target }}"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target: [Release]

    steps:
      - name: "Free disk space"
        run: |
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache/go
          sudo apt-get clean
          df -h
          
      - name: "Checkout sources"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          
      - name: "Setup Java"
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "17"
          
      - name: "Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
          
      - name: "Execute Gradle assemble"
        run: "./gradlew assemble${{ matrix.target }}"
        
      - name: "Find and prepare APK files"
        run: |
          mkdir -p collected-apks
          
          echo "=== Searching for APK files ==="
          
          # Ищем play-services-core APK
          if [ -d "play-services-core/build/outputs/apk" ]; then
            echo "Looking for play-services-core APKs..."
            find play-services-core/build/outputs/apk -name "*.apk" -type f | while read apk; do
              echo "Found: $apk"
              cp "$apk" collected-apks/
            done
          fi
          
          # Ищем vending-app APK
          if [ -d "vending-app/build/outputs" ]; then
            echo "Looking for vending-app APKs..."
            find vending-app/build/outputs -name "*.apk" -type f | while read apk; do
              echo "Found: $apk"
              cp "$apk" collected-apks/
            done
          fi
          
          # Показываем результаты
          echo ""
          echo "=== Collected APK files ==="
          if [ -n "$(ls -A collected-apks)" ]; then
            ls -la collected-apks/
            echo "apk_count=$(ls -1 collected-apks/ | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "No APK files found!"
            echo "apk_count=0" >> $GITHUB_OUTPUT
          fi
        id: find-apk
        
      - name: "Upload APK artifacts"
        if: steps.find-apk.outputs.apk_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: microg-apks-${{ matrix.target }}-${{ github.sha }}
          path: collected-apks/
          compression-level: 6
          retention-days: 7
